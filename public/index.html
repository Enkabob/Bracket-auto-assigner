<!DOCTYPE html>
<html lang="en" class="bg-slate-950 text-slate-100">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Start.gg Auto-Manager | Command Center</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&family=JetBrains+Mono:wght@500&display=swap');
        
        body { font-family: 'Inter', sans-serif; }
        .mono { font-family: 'JetBrains+Mono', monospace; }

        /* The "Caution Tape" Stripe Effect for Offline Stations */
        .card-offline {
            background-image: repeating-linear-gradient(
                45deg,
                transparent,
                transparent 10px,
                rgba(255, 255, 255, 0.05) 10px,
                rgba(255, 255, 255, 0.05) 20px
            );
        }

        .overtime-flash { animation: flash 1.5s infinite; }
        @keyframes flash { 0%, 100% { border-color: #f43f5e; box-shadow: 0 0 15px rgba(244, 63, 94, 0.3); } 50% { border-color: #450a0a; box-shadow: none; } }
    </style>
</head>
<body class="p-8">

    <!-- HEADER SECTION -->
    <header class="flex justify-between items-start mb-10 border-b border-slate-800 pb-6">
        <div class="flex items-center gap-6">
            <!-- Sync Timer (Clickable) -->
            <div onclick="forceUpdate()" class="group cursor-pointer flex items-center gap-3 bg-slate-900 border border-slate-800 rounded-full px-5 py-2 hover:border-cyan-500 transition-all active:scale-95">
                <div id="sync-indicator" class="w-2.5 h-2.5 bg-cyan-500 rounded-full shadow-[0_0_10px_#22d3ee]"></div>
                <div class="text-[10px] font-black tracking-widest uppercase">
                    NEXT SYNC: <span id="countdown-text" class="text-cyan-400 ml-1">--s</span>
                </div>
            </div>
            
            <div>
                <h1 class="text-3xl font-black tracking-tighter text-white italic">AUTO-MANAGER <span class="text-cyan-500">v1.0</span></h1>
                <p id="status-text" class="text-slate-500 text-[10px] uppercase font-black tracking-[0.2em] mt-1">Establishing Uplink...</p>
            </div>
        </div>

        <div class="flex items-center gap-4">
            <!-- Automation Master Toggle -->
            <div class="flex items-center gap-2 bg-slate-900 border border-slate-800 rounded-lg p-1">
                <span class="text-[9px] font-bold opacity-40 uppercase px-2">Automation</span>
                <button id="bot-toggle-btn" onclick="toggleBot()" class="px-4 py-1.5 rounded text-[10px] font-black transition-all">
                    PAUSED
                </button>
            </div>

            <!-- Nuclear Reset -->
            <button onclick="confirmReset()" class="group flex items-center gap-2 bg-rose-950/20 border border-rose-900/30 hover:bg-rose-600 hover:text-white px-5 py-2.5 rounded-lg transition-all">
                <span class="text-[10px] font-black tracking-widest text-rose-500 group-hover:text-white uppercase">Nuclear Reset</span>
            </button>
            
            <div id="clock" class="text-2xl mono text-slate-700 ml-4">00:00:00</div>
        </div>
    </header>

    <main class="grid grid-cols-12 gap-8">
        
        <!-- LEFT: STATION GRID -->
        <div class="col-span-9">
            <h2 class="text-sm font-black text-slate-500 uppercase tracking-[0.3em] mb-6 flex items-center">
                <span class="w-2 h-2 bg-cyan-500 rounded-full mr-3"></span> Active Setups
            </h2>
            <div id="station-grid" class="grid grid-cols-3 gap-6">
                <!-- Station Cards injected here -->
            </div>
        </div>

        <!-- RIGHT: SIDEBAR (ALERTS & QUEUE) -->
        <div class="col-span-3 space-y-8">
            <!-- Overtime Alerts -->
            <section>
                <h2 class="text-xs font-black text-rose-500 uppercase tracking-[0.3em] mb-4">Overtime Alerts</h2>
                <div id="alert-list" class="space-y-3"></div>
            </section>

            <!-- Pending Queue -->
            <section>
                <h2 class="text-xs font-black text-cyan-500 uppercase tracking-[0.3em] mb-4">Pending Queue</h2>
                <div id="queue-list" class="bg-slate-900/50 rounded-xl border border-slate-800 p-4 space-y-4">
                    <!-- Queue items injected here -->
                </div>
            </section>
        </div>

        <!-- BOTTOM: TOURNAMENT MONITOR -->
        <div class="col-span-12 mt-12 border-t border-slate-800 pt-8">
            <h2 class="text-xs font-black text-slate-500 uppercase tracking-[0.3em] mb-6">Tournament Monitor (Phase Groups)</h2>
            <div id="monitor-list" class="grid grid-cols-5 gap-4">
                <!-- Pool status badges injected here -->
            </div>
        </div>
    </main>

    <script>
        const socket = io();
        let botActive = false;
        let nextUpdateAt = Date.now();
        let countdownInterval;

        socket.on('update', (data) => {
            // Update Header & Clock
            document.getElementById('status-text').innerText = `Last Successful Sync: ${data.timestamp}`;
            document.getElementById('clock').innerText = data.timestamp;
            nextUpdateAt = data.lastUpdate + data.nextUpdateIn;
            startCountdown();

            // Update Bot Toggle UI
            botActive = data.isBotActive;
            const btn = document.getElementById('bot-toggle-btn');
            btn.innerText = botActive ? 'RUNNING' : 'PAUSED';
            btn.className = botActive 
                ? 'px-4 py-1.5 rounded text-[10px] font-black bg-cyan-500 text-slate-950 shadow-[0_0_15px_rgba(6,182,212,0.4)]' 
                : 'px-4 py-1.5 rounded text-[10px] font-black bg-slate-800 text-slate-400';

            // 1. RENDER STATIONS
            const grid = document.getElementById('station-grid');
            grid.innerHTML = data.stations.map(s => {
                const isOffline = s.status === 'OFFLINE';
                const isOvertime = data.alerts.some(a => a.includes(s.match));
                
                return `
                <div class="p-5 rounded-2xl border-2 transition-all relative overflow-hidden ${getStatusStyle(s.status)} ${isOvertime ? 'overtime-flash' : ''} ${isOffline ? 'card-offline' : ''}">
                    ${s.eventName ? `<div class="absolute -top-0 left-6 px-3 py-1 bg-slate-800 border border-t-0 border-slate-700 rounded-b-lg text-[8px] font-black uppercase tracking-widest text-cyan-400 shadow-xl">${s.eventName}</div>` : ''}
                    
                    <div class="flex justify-between items-start mb-6 mt-2">
                        <span class="text-4xl font-black italic tracking-tighter opacity-80">#${s.number}</span>
                        <button onclick="toggleStation('${s.id}')" class="text-[9px] font-black bg-slate-800/80 hover:bg-white hover:text-black px-3 py-1.5 rounded-md border border-white/5 transition-all">
                            ${isOffline ? 'ENABLE' : 'DISABLE'}
                        </button>
                    </div>
                    
                    <div class="text-[10px] font-black uppercase opacity-40 mb-1 tracking-[0.2em]">${s.status}</div>
                    <div class="text-lg font-bold h-14 overflow-hidden leading-tight text-white mb-4">${s.match || '<span class="opacity-10 italic">READY FOR MATCH</span>'}</div>
                    
                    <!-- Progress Section -->
                    <div class="flex justify-between items-end">
                         ${s.matchId && s.status !== 'EMPTY' ? `
                            <button onclick="addTime('${s.matchId}')" class="text-[9px] font-black bg-white/5 hover:bg-cyan-500 hover:text-black px-3 py-1.5 rounded transition-all">
                                +5m EXTEND
                            </button>
                        ` : '<div></div>'}
                        <span class="text-[10px] mono opacity-40">${s.percent > 0 ? Math.floor(s.percent) + '%' : ''}</span>
                    </div>

                    <!-- Terminus Progress Bar -->
                    <div class="absolute bottom-0 left-0 h-1.5 bg-white/5 w-full">
                        <div class="h-full bg-cyan-500 shadow-[0_0_12px_#06b6d4] transition-all duration-1000" style="width: ${s.percent}%"></div>
                    </div>
                </div>
                `;
            }).join('');

            // 2. RENDER QUEUE
            const qList = document.getElementById('queue-list');
            qList.innerHTML = data.queue.map(q => `
                <div class="text-[11px] border-l-2 ${q.isPreview ? 'border-amber-500 bg-amber-500/5' : 'border-cyan-500'} pl-3 py-1">
                    <div class="flex justify-between items-center mb-1">
                        <span class="text-slate-500 font-black uppercase text-[9px] tracking-tighter">${q.eventName}</span>
                        ${q.isPreview ? '<span class="text-[7px] bg-amber-600 text-white px-1.5 py-0.5 rounded uppercase font-black">Unstarted</span>' : ''}
                    </div>
                    <div class="${q.isPreview ? 'text-slate-500 italic' : 'text-slate-200 font-semibold'}">${q.friendlyName}</div>
                </div>
            `).join('') || '<p class="text-slate-600 text-[10px] italic">No pending matches</p>';

            // 3. RENDER ALERTS
            const aList = document.getElementById('alert-list');
            aList.innerHTML = data.alerts.map(a => `
                <div class="bg-rose-500 text-white p-3 rounded-lg text-[10px] font-black flex items-center gap-2 shadow-lg shadow-rose-900/20">
                    <span class="text-lg">⚠️</span> ${a.toUpperCase()}
                </div>
            `).join('');

            // 4. RENDER MONITOR
            const mList = document.getElementById('monitor-list');
            mList.innerHTML = data.monitorStatus.map(m => `
                <div class="bg-slate-900 border border-slate-800 p-3 rounded-xl flex justify-between items-center">
                    <div>
                        <div class="text-[8px] text-slate-500 font-black uppercase tracking-tighter">${m.event}</div>
                        <div class="text-[10px] font-bold text-slate-300">${m.phase} <span class="text-cyan-500 ml-1">#${m.pool}</span></div>
                    </div>
                    <span class="px-2 py-1 rounded text-[8px] font-black ${m.state === 'ACTIVE' ? 'bg-cyan-500/10 text-cyan-400 border border-cyan-500/20' : m.state === 'UNSTARTED' ? 'bg-amber-500/10 text-amber-500 border border-amber-500/20' : 'bg-slate-800 text-slate-500'}">
                        ${m.state}
                    </span>
                </div>
            `).join('');
        });

        // UI HELPERS
        function getStatusStyle(status) {
            switch(status) {
                case 'EMPTY': return 'bg-slate-900/40 border-slate-800 text-slate-500 hover:bg-slate-900 transition-colors';
                case 'CALLED': return 'bg-yellow-500/5 border-yellow-500/20 text-yellow-500';
                case 'ENGAGED': return 'bg-cyan-500/5 border-cyan-500/20 text-cyan-400';
                case 'OFFLINE': return 'bg-slate-950 border-slate-900 text-slate-700 opacity-40 grayscale scale-[0.98]';
                default: return 'bg-slate-900 border-slate-800';
            }
        }

        function startCountdown() {
            if (countdownInterval) clearInterval(countdownInterval);
            countdownInterval = setInterval(() => {
                const remaining = Math.max(0, Math.floor((nextUpdateAt - Date.now()) / 1000));
                document.getElementById('countdown-text').innerText = `${remaining}s`;
                if (remaining <= 3) document.getElementById('sync-indicator').classList.add('animate-ping');
                else document.getElementById('sync-indicator').classList.remove('animate-ping');
            }, 1000);
        }

        // SOCKET EMITTERS
        function toggleStation(id) { socket.emit('toggle-station', id); }
        function toggleBot() { socket.emit('toggle-bot', !botActive); }
        function confirmReset() { if(confirm("☢️ NUCLEAR RESET: Unassign ALL stations and pause bot?")) socket.emit('reset-all-called'); }
        function addTime(setId) { socket.emit('add-timer', setId); }
        function forceUpdate() { socket.emit('force-update'); document.getElementById('sync-indicator').classList.add('animate-spin'); }
    </script>
</body>
</html>